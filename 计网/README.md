* “王道”指王道2020计网复习指导
* “课本”指《xxx》

## 计算机网络体系结构

### 概述

计算机网络的概念：
* 资源共享的观点：认为第一目的是资源共享

计算机网络的组成：
* 从组成部分上看：由硬件，软件和协议组成
* 从工作方式上看：分为边缘部分和核心部分。边缘部分指主机，核心部分是网络和路由器
* 从功能组成上看：通信子网和资源子网。通信子网由介质、设备和协议组成，资源子网由实现资源共享的设备和软件组成

计算机网络的功能：计算机网络最基本最重要的功能是**数据通信**。

计算机网络的分类：
* 按分布范围分类：
  * WAN广域网：因特网的核心部分，提供长距离通信。
  * MAN城域网：范围顾名思义，大多采用以太网技术，因此一般并入局域网范围讨论。
  * LAN局域网：覆盖范围几十米到几千米。
  * PAN个人区域网：覆盖直径10m。
  * **传统上，局域网使用广播技术，而广域网使用交换技术**。
* 按拓扑结构分类（拓扑结构一般指通信子网的拓扑结构）：
  * 星形：每个终端以单独的线路与中央设备相连。
  * 总线性：用单根传输线连接所有终端。
  * 环形：所有终端连成一个环。
  * 网状形：每个结点至少有两条路径与其它结点相连。
  * 前三种多用于局域网，网状形多用于广域网。
* 按交换技术分类（王道2.1有展开）：
  * 电路交换
  * 报文交换：也叫存储-转发网络，报文大小不确定
  * 分组交换/包交换：包大小固定，以存储-转法方式传输。相比于报文交换，缓冲区更好管理，现在基本都用分组交换。

性能指标：
* Speed速率：信道上传输数据的速率，也叫数据率/比特率，单位是b/s。
* Bandwidth带宽：信道的最高速率，单位是b/s。
* **Transmission Delay传输延迟/发送时延**：将所有比特推向链路的时间，等于`分组长度 / 信道宽度`。
* **Propagation Delay传播延迟**：电磁波在信道中传播一定距离的时间，等于`信道长度 / 电磁波在信道上的传输速率`。
* Process Delay处理延迟：数据在交换结点进行必要操作花费的时间，比如分析首部、差错校验、查找路由等。
* Queuing Delay排队延迟：**分组**进入路由器后在等待队列等待的时间，以及在路由器输出队列等待转发的时间。
* 数据在网络中经历的总时延 = 以上四个时延之和。
* Round Trip Time(RTT)往返时延：从发送数据开始，到收到来自接收端的确认信息的时间。

**高速链路提高的只是数据发送速率而不是传播速率，因此只减少了发送时延**。

### 体系结构

体系结构是计算机网络的各层及其协议的集合。关注抽象概念，不关注具体实现。

分层结构：
* 分层结构最低层为第一层，即物理层。
* 每一层向上层提供服务，并调用下一层提供的服务。
* SDU服务数据单元是一层中传送的数据，加上PCI协议控制信息，即控制头，组成这一层的PDU协议数据单元。
* 上一层的PDU作为下层的SDU，加上该层的PCI成为该层的PDU。
* 物理层的PDU称为**比特**，链路层PDU称为**frame帧**，网络层PDU称为**datagram分组/数据报**，传输层PDU称为**segment报文/用户数据报**，应用层PDU称为**message消息**。

网络协议：为进行数据交换建立的规则集合。协议只规定于对等实体之间，即同一层的实体间。

接口：相邻两层交换信息的连接点。比如相邻实体通过SAP服务访问点交互，SAP就是一种逻辑接口。

计算机网络提供的服务可按三种方式分类：
* **面向连接服务和无连接服务**
  * 面向连接的服务：双方通信前必须先建立连接和分配资源，通信结束后必须释放连接和资源。通常有连接建立 - 数据传输 - 连接释放三个阶段。
  * 无连接服务：通信双方不需要先建立连接，这是一种**不可靠**服务，提供Best effort delivery最大努力交付。
* **可靠服务和不可靠服务**：
  * 可靠服务：网络具有纠错、检错、应答机制，能保证数据正确、可靠地到达目的地。
  * 不可靠服务：网络尽量正确、可靠地传送，不做任何保证。
* 有应答服务和无应答服务

#### OSI参考模型

开放系统互连参考模型（OSI/RM），简称OSI参考模型。共7层，低三层为通信子网，高三层为资源子网。

* Physical Layer物理层：在物理媒体上透明地传输原始比特流，主要规定数据终端和数据通信设备的物理与逻辑连接方法，因此物理层协议也叫**物理层接口标准**。物理层的内容：
  * 规定电路接口的参数，比如电脑网线接口的参数。
  * 规定通信链路上传输的信号的意义和电器特征，比如规定0和1代表的信号是什么。
  * 但是传输用到的物理媒体，比如双绞线、光缆、无线信道等，不属于物理层而在物理层之下，可以称为第0层物理媒体层。
* Data Link Layer数据链路层：组装帧、差错控制、流量控制、传输管理。
* Network Layer网络层：控制通信子网的运行，包括分组路由选择、差错控制、流量控制、拥塞控制、网际互连。提供点到点通信。
* Transport Layer传输层：为端到端连接提供**可靠（即是面向连接的）**的传输服务，包括差错控制、流量控制、服务质量、数据传输管理。提供端到端通信。
* Session Layer会话层：为表示层实体或用户进程建立连接并在连接上有序地传输数据，即进行会话。会话层可以建立、管理及终止会话，还可以使用校验点在通信失效时恢复通信。
* Presentation Layer表示层：处理交换的信息的表示方式。定义数据结构，选用编码方式，还可以提供数据压缩、解密加密等功能。
* Application Layer应用层：与用户交互。

#### TCP/IP模型

TCP/IP模型是广泛应用的标准，是事实上的国际标准。

* 网络接口层：对应OSI的物理层和数据链路层。
* 网际层：与OSI网络层类似。
* 传输层：与OSI传输层类似。
* 应用层：所有高层协议。

王道p19图：TCP/IP模型以IP作为核心协议，提供everything over IP的服务，以及IP over everything的在IP协议各种网络上运行。

TCP/IP与OSI参考模型的比较：王道p19，OSI参考模型的网络层支持面向连接和无连接的通信，但传输层只有面向连接的通信；TCP/IP模型的网络层只有无连接的通信，但传输层支持面向连接和无连接通信。

学习时采用折中的观点，学习五层结构。

## 物理层

### 通信基础

#### 基本概念

数据：
* 模拟信号：连续变化的信号
* 数字信号：取值为离散数值的信号

码元：用一个固定时长的信号波形表示一位k进制数字，是数字信号的计量单位。

信道：在信源和信宿之间传递数据的逻辑部件，一般指传送数据的介质。

信道上传输的信号有基带信号和宽带信号之分（王道p60）：
* **基带传输**：基带信号将**数字信号**1和0直接用两种电压表示，然后传送到**数字信道**上传输
* **频带传输**：将数字信号调制成**模拟信号**，然后传送到**模拟信道**上传输。
* **宽带传输**：将频带传输中的链路分为多个信道，每个信道传输不同的信号，比如采用频分复用技术。

三种基本的通信方式（[wiki](https://zh.wikipedia.org/wiki/%E9%9B%99%E5%B7%A5)）：
* 单工通信：只有一个方向的通信，只有一条信道。”电视信号“。
* 半双工通信：通信双方都可以发送和接收，但是不能同时进行，需要两条信道。“对讲机”。
* 全双工通信：通信双方都可以发送和接收，也需要两条信道。“双向车道”。

码元传输速率：单位时间传输码元的个数，也可以称为脉冲个数或信号变化的次数，单位是Baud波特。

#### 奈奎斯特定理与香农定理

Nyquist定理：理想低通信道中，**极限码元传输速率**为**2W波特**，其中W是理想低通信道的带宽。

用V表示每个码元离散电平的数目（即有多少种不同的码元，n个二进制位就可以表示2^n个不同的码元），则可得**极限数据传输率**为`2W * log2(V)`，单位是b/s。

Shannon定理：给出了带宽受限且有高斯白噪声干扰的信道的**极限数据传输率**，为`W * log2(1 + S/N)`，单位是b/s，其中W是信道的带宽，S是信道所传输信号的平均功率，N是信道内部的高斯噪声功率。

S/N即为信噪比，即信号的平均功率与高斯噪声的平均功率之比，`信噪比 = 10 * log10(S/N)`，单位为dB。

#### 调制与编码

传输数据时需要将数据转换为信号，将数据变为模拟信号的过程称为调制，将数据变为数字信号的过程称为编码。

四种转换方式：
* 数字数据**编码**为数字信号：编码主要就是规定什么数字信号表示0和什么数字信号表示1，常用的编码方法有：
  * 非归零编码(NRZ)：用一个电压表示一个二进制数字。简单，但无法判断一个码元的开始和结束
  * 非归零反向编码(NRZI)：与前一码元的电平相反表示1，相同表示0（或01的表示反过来）
  * **曼彻斯特编码**：将一个码元分成两个相等的间隔，前一个为高电平后一个为低电平表示码元，相反的表示0（或相反表示，都可以）。每个码元中间出现的跳变，既包含时钟信号，又包含数据信号，码元宽度和NRZ相同，但是所占的频带宽度是原始基带宽度的2倍，**以太网使用的就是曼彻斯特编码**。
  * 差分曼彻斯特编码：前半个码元的电平与上一个码元的后半个电平相同表示1，相反表示0，同样在每个码元的中间都有一次电平跳转。
  * 4B/5B编码
* 数字数据**调制**为模拟信号：调制技术在发送端将数字信号转换为模拟信号（调制），在接收端将模拟信号还原为数字信号（解调）
* 模拟数据**编码**为数字信号：主要包括采样、量化和编码。
  * 奈奎斯特采样定理：采样频率至少为原始信号最大频率的两倍，才能保证采样后的数字信号完整保留原始模拟信号的信息。
* 模拟数据**调制**为模拟信号。

#### 电路交换、报文交换与分组交换

电路交换：进行传输前，两个节点间必须先建立一条专用的物理通信路径，在传输过程中一直被独占。因此电路交换有连接建立 - 数据传输 - 链接释放三个阶段。电路交换的特点：
* 数据传输时延小，不会有存储转发耗费时间
* 有序传输：顺序传送数据，不会出现失序问题
* 没有冲突
* 交换机等控制简单
* **无法纠错**
* 建立连接时间长

报文交换：存储转发方式。特点：
* 报文大小没有限制，需要网络结点有较大的缓存空间（报文需要全部暂存在中间结点）
* 现在很少使用，被分组通信方式所替代

分组交换：也是存储转发方式，限制了分组大小上限。分组交换有两种方式（王道p39表2.1对比）：
* 数据报：将数据报拆成数据报分组发送，不同的分组可以走不同的路线，可也以不同顺序到达
  * 无连接，不可靠
  * 网络有冗余路径，对故障适应能力强
* 虚电路：在分组发送前，建立逻辑相连的虚电路，且建立后就固定虚电路的物理路径
  * 面向连接，提供可靠的传输，保证每个分组有序到达
  * 虚体现在，每个结点可以同时被多条虚电路经过
  * 虚电路的持续时间可以不同，有临时性的，也有永久的虚电路

### 传输介质

双绞线：
* 最常用的古老传输介质，常用于局域网和传统电话网络
* 带宽取决于铜线的粗细和传输的距离
* 模拟传输和数字传输都可以使用

同轴电缆：
* 50Ω同轴电缆用于传输基带数字信号 - 基带同轴电缆，在局域网应用广泛
* 75Ω同轴电缆用于传输宽带信号 - 宽带同轴电缆，常用于有线电视
* 传输距离比双绞线长，但更贵

光纤：
* 由纤心和包层组成，纤心不是中空的
* 纤心折射率高，包层折射率低，因此光线在光纤中发生全反射，以此向前传播
* 多模光纤：多束光线同时在一条光纤传播，传输距离短
* 单模光纤：光线直径为一个光波长度，光线反射次数很小，传输距离长

物理层尽可能屏蔽物理设备的差异，不关注具体的传输媒介（王道p59图2.12），物理层的主要任务可以描述为确定与传输媒体的接口有关的一些特性：
* 机械特性：主要定义物理连接的边界点，即接插装置的规格、引线数目、引脚等。
* 电气特性：规定传输二进制位时，线路上信号的电压高低、阻抗匹配、传输速率和距离限制等。
* **功能特性**：指明某条线上出现的某一电平的电压表示什么意义（即比如编码规则），接口部件的信号线（数据线、控制线、定时线）用途。
* 规程特性：主要定义各条物理线路的工作规程和时序关系。

### 物理层设备

**中继器/转发器**：将信号整形并放大（原理是信号再生，并非简单放大）再转发出去，以消除信号经过一长段电缆后，因噪声或其他原因造成的失真和衰减。

中继器放大数字信号，放大器方法模拟信号。

**如果一个设备有存储转发功能，那么认为它可以连接两个不同的协议**。中继器没有存储转法功能，因此不能连接两个速率不同的网段，不能连接不同的协议（**指物理层协议不同的网段不能互连，与上层协议是否相同无关**，王道p57选择题3），中继器扩大了网络规模，但是相连部分仍是一整个局域网。

**Hub集线器**：实质上是一个多端口的中继器。因此也只起到信号放大和转发的作用，不能隔绝冲突域；只能在半双工下工作，因此多个设备共用会降低效率；拓扑结构为星形。

## 数据链路层

### 数据链路层的功能

* 为网络层提供服务：可以提供无确认无连接，有确认无连接，有确认有连接的服务，不存在无确认有连接的服务。
* 组帧：将网络层的分组封装成帧，其中包括定义数据结构，首尾部分的帧定界等。
* 链路管理：主要用于面向连接的服务，提供通信前的状态确认、控制等。
* 流量控制：限制发送方的发送速率不超过接收方的接收能力，数据链路层是点对点的流量控制。
* 差错控制：
  * 位错：帧中某位出现差错。通常用CRC码检验，通过ARQ自动重传（丢弃错误帧，让发送方超时自动重传）请求重发出错的帧。
  * 帧错：帧丢失、重复或失序。用计时器解决丢失；用编号机制解决重复；失序的解决这里不关注。

### 组帧

组帧主要解决的问题有：
* 帧定界：确定帧的界限。
* 帧同步：从接收到的比特流中区分出起始和终止。
* 透明传输：不论数据中有什么比特组合都能传输，不会因出现与帧定界符相同的比特组合而传输错误。

组帧时既要加首部，也要加尾部。

组帧方法：
* 字符计数法：在帧头用一个计数字段标明帧内字符数（总字符数包括计数字段）。
* 字符填充的首位定界符法：字符填充法用一些特殊字符来标明首和尾，若帧的数据部分中也出现转义字符，发送方在之前再加一个转义字符，接收方收到后再去掉这个转义字符，达到透明传输。
* 比特填充的首位标志法：用`01111110`标志帧的开始和结束，同样为了实现透明传输，发送方在数据中遇到5个连续的`1`时，在之后插入一个`0`，接收方做相反操作。
* 违规编码法：用冗余的违规编码序列作为起始界定符，比如曼彻斯特编码的“高-高”和“低-低”，这时不需要任何填充就能实现透明传输。

### 差错控制

CRC码，见计组。

### 流量控制与可靠传输机制

**数据链路层的流量控制与可靠传输机制是交织在一起的**，三种常用的ARQ机制都是滑动窗口和超时重传结合的。

**流量控制**的两种主要方法：
* 停止-等待：发送方每发送一帧，都要等待接收方的确认后才能发送下一帧。
* 滑动窗口：发送方和接收方各维护一个窗口。**数据链路层的滑动窗口与传输层的滑动窗口相比，窗口大小是固定的**。

**可靠传输**的实现：
* 确认机制。
* 超时重传。其中，自动重传请求(Auto Repeat reQuest, ARQ)是常用方法，传统的自动重传有三种：
  * 停止等待(Stop and Wait)ARQ
  * 后退N帧(Go Back N)ARQ
  * 选择重传(Selective Repeat)ARQ

超时重传的三种常用方法中，后两种当窗口足够大时，帧在线路上可以连续流动，因此又称连续ARQ。

* **停止等待**：
  * **发送窗口大小 = 1，接收窗口大小 = 1**
  * 帧发送后，若发送方在计时器超时仍未收到确认，重新发送该帧
  * 接收方遇到帧错误，直接丢弃该帧
  * 发送的帧交替用0和1标识
* **后退N帧**：
  * **发送窗口大小 > 1，接收窗口大小 = 1**
  * 接收方对收到的最后一个连续无误的帧进行确认
  * 接收方不用在每收到一个帧就发送确认，可以在连续收到几个后发送最后一个确认
  * 发送方每个帧一个计时器，当一帧的计时器超时，重发该帧及该帧后**已发送的所有帧**
  * **若用nbit对帧编号，发送窗口尺寸最大为2^n - 1，超过会无法区分新帧旧帧**
* **选择重传**：
  * **发送窗口大小 > 1，接收窗口大小 > 1**
  * 接收方可以发送NAK给发送方，请求立即重传该帧
  * 接收方缓冲区用于暂存未按顺序收到的帧，大小等于窗口大小
  * 发送方每个帧一个计时器，超时重传对应帧
  * **若用nbit对帧编号，发送窗口和接收窗口大小和最大为2^n，超过会无法区分新帧旧帧**
  * 一般SR机制中发送窗口和接收窗口大小一样，因此它们最大尺寸都是2^(n-1)

与流量控制和可靠传输相关的计算：
* 信道效率/信道利用率：在一个发送周期内，发送方有效发送数据的时间
* 信道吞吐率：信道利用率 * 发送方的发送速率

### 介质访问控制

在广播中结点会共享广播信道，因此需要为使用介质（信道）的每个结点隔离来自同一信道上其它结点所传送的信号，即介质访问控制。

决定广播信道中信道分配的协议属于数据链路层的一个子层，称为**介质访问控制（Medium Access Control, MAC）子层**。

常见的介质访问控制方法：
* 信道划分介质访问控制：静态分配信道
* 随机访问介质访问控制：动态分配信道
* 轮询访问介质访问控制：动态分配信道

#### 信道划分介质访问控制

信道划分介质访问控制将使用介质的每个设备和其他设备隔离，将一条广播信道划分为逻辑上互不干扰的子信道，采用多路复用计数（一条介质同时携带多个传输信号）实现，种类如下：
* 频分多路复用FDM：共享时间，“公路划分为两个车道”
* 时分多路复用TDM：共享空间，“交替使用公路”。TDM的改进为统计时分多路复用，按需动态分配时隙。
* 波分多路复用WDM：即光的频分多路复用，在光纤中使用，共享时间
* 码分多路复用：共享时间空间，“黄豆绿豆装在一个车厢内运输”
  * **码分多址**(**Code Division Multiple Access, CDMA**)是码分复用的一种方式，将时间划分为时间槽，码片，每个站点有唯一的码片序列且相互正交，多个站点共享信道时，将他们对应的码片序列线性相加，最后与对应站点的码片序列做内积就能分解出信息。

#### 随机访问介质访问控制

不采用集中控制发送次序，既不共享时间也不共享空间，核心思想是争用信道的使用权，因此随机访问介质访问控制协议又称**争用型协议**。

* ALOHA协议：发送前不侦听
  * 纯ALOHA协议：
    * 站点不进行检测自由发送数据，若超时未收到确认，认为发生了冲突，等待一个随机时间后重传
    * 遇到碰撞时，碰撞双方都需要重传，等待时间是一个随机时间 
  * 时隙ALOHA协议：
    * 将时间划分为等长的时隙Slot，只能在每个时隙开始时发送帧，站点发送前仍不进行检测
    * 遇到碰撞时，重传也是双方等待随机时间重传
* **CSMA协议**（**Carrier Sense Multiple Access，载波侦听多路访问**）：发送前会侦听信道是否空闲
  * 1-坚持CSMA（1-persistent CSMA）：
    * 发送数据前先侦听信道，若信道空闲，**立即**发送数据；若信道忙，则一直等待并监听
    * 遇到碰撞时，随即等待一段时间后再开始侦听
  * 非坚持CSMA（Non-persistent CSMA）：
    * 发送数据前先侦听信道，若空闲，**立即**发送数据；若信道忙，等待一个随机时间后再侦听
  * p-坚持CSMA（P-persistent CSMA）：
    * 发送数据前先侦听信道，若空闲，**不立即**发送数据，以概率p发送数据，概率1-p推迟到下一时隙再侦听，下一时隙若也空闲，以概率p发送，概率1-p推迟...；若在一开始检测到信道忙，等待到下一时隙再侦听；若在推迟过程中检测到信道忙，等待一个随机时间后再侦听
    * **首次遇到碰撞和1-p推迟后遇到碰撞的等待时间不同**
    * 不直接发送，持续侦听（指首次碰撞），p-坚持CSMA是前两种协议的折中
* **CSMA/CD协议**（**Carrier Sense Multiple Access with Collision Detection, CSMA/CD，载波侦听多路访问/碰撞检测**）：
  * 发送前侦听信道，若空闲则发送数据；若信道忙，则持续侦听到信道空闲
  * 传输过程中持续侦听信道，若没有侦听到别的信道发送，则成功传输；若侦听到有别的信道在发送，则终止传输，并发送一个拥塞信号，然后用**二进制指数退避算法**等待一个随机时间后再侦听
  * **争用期**：知道没有发生碰撞的最短时间，理解。求最短帧长。
  * 二进制指数退避算法：
    * 基本退避时间：一般为争用期时间
    * 参数k = min{重传次数，10}
    * 从[0, 1, 3, 7...2^k-1]中随机选出一个作为r，退避时间 = r * 基本退避时间
    * 重传16次仍不成功，放弃重传该帧 
* **CSMA/CA协议**（**Carrier Sense Multiple Access with Collision Avoidance, CSMA/CA，载波侦听多路访问/碰撞避免**）
  * CSMA/CD用于有线局域网，但在无线局域网下需要进行改进，因此将碰撞检测改为碰撞避免，避免指尽量降低发生碰撞的概率，但不能完全消除碰撞
  * 基本思想是在发送数据前告诉其他结点不要发送数据，以避免发送碰撞，实现冲突避免的机制有：
    * 预约信道：发送数据的同时通知其他结点自己占用的时间长度
    * ACK帧：接收成功后发送ACK帧，发送方超时未收到ACK帧认为发送失败
    * RTS/CTS帧：可选机制，解决“隐蔽站”问题。（王道p97选择27，RTS和CTS用于预约信道）
  * 在发送前使用二进制指数退避算法等待退避时间，避免冲突

#### 轮询访问介质访问控制

轮询方式用户不能随机发送数据，需要通过集中控制的控制站，轮询每个结点决定信道分配，且某结点使用时，其他结点不能使用信道。

令牌传递协议：
* 令牌是有一组特殊的比特组成的帧
* 只有拥有令牌才能传输数据，拥有令牌的结点发送帧，帧在环上传送时所有结点都会转发，传送完一帧后，释放令牌
* 只有一个令牌，因此不会出现冲突
* 令牌传递协议适用于负载高的广播信道，因为相比于随机访问介质访问控制，不会出现冲突



## 网络层

## 传输层

## 应用层

