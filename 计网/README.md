* “王道”指王道2020计网复习指导
* “课本”指《xxx》

## 计算机网络体系结构

### 概述

计算机网络的概念：
* 资源共享的观点：认为第一目的是资源共享

计算机网络的组成：
* 从组成部分上看：由硬件，软件和协议组成
* 从工作方式上看：分为边缘部分和核心部分。边缘部分指主机，核心部分是网络和路由器
* 从功能组成上看：通信子网和资源子网。通信子网由介质、设备和协议组成，资源子网由实现资源共享的设备和软件组成

计算机网络的功能：计算机网络最基本最重要的功能是**数据通信**。

计算机网络的分类：
* 按分布范围分类：
  * WAN广域网：因特网的核心部分，提供长距离通信。
  * MAN城域网：范围顾名思义，大多采用以太网技术，因此一般并入局域网范围讨论。
  * LAN局域网：覆盖范围几十米到几千米。
  * PAN个人区域网：覆盖直径10m。
* 按拓扑结构分类（拓扑结构一般指通信子网的拓扑结构）：
  * 星形：每个终端以单独的线路与中央设备相连。
  * 总线性：用单根传输线连接所有终端。
  * 环形：所有终端连成一个环。
  * 网状形：每个结点至少有两条路径与其它结点相连。
  * 前三种多用于局域网，网状形多用于广域网。
* 按交换技术分类（王道2.1有展开）：
  * 电路交换
  * 报文交换：也叫存储-转发网络，报文大小不确定
  * 分组交换/包交换：包大小固定，以存储-转法方式传输。相比于报文交换，缓冲区更好管理，现在基本都用分组交换。

性能指标：
* Speed速率：信道上传输数据的速率，也叫数据率/比特率，单位是b/s。
* Bandwidth带宽：信道的最高速率，单位是b/s。
* **Transmission Delay传输延迟/发送时延**：将所有比特推向链路的时间，等于`分组长度 / 信道宽度`。
* **Propagation Delay传播延迟**：电磁波在信道中传播一定距离的时间，等于`信道长度 / 电磁波在信道上的传输速率`。
* Process Delay处理延迟：数据在交换结点进行必要操作花费的时间，比如分析首部、差错校验、查找路由等。
* Queuing Delay排队延迟：**分组**进入路由器后在等待队列等待的时间，以及在路由器输出队列等待转发的时间。
* 数据在网络中经历的总时延 = 以上四个时延之和。
* Round Trip Time(RTT)往返时延：从发送数据开始，到收到来自接收端的确认信息的时间。

**高速链路提高的只是数据发送速率而不是传播速率，因此只减少了发送时延**。

### 体系结构

体系结构是计算机网络的各层及其协议的集合。关注抽象概念，不关注具体实现。

分层结构：
* 分层结构最低层为第一层，即物理层。
* 每一层向上层提供服务，并调用下一层提供的服务。
* SDU服务数据单元是一层中传送的数据，加上PCI协议控制信息，即控制头，组成这一层的PDU协议数据单元。
* 上一层的PDU作为下层的SDU，加上该层的PCI成为该层的PDU。
* 物理层的PDU称为**比特**，链路层PDU称为**frame帧**，网络层PDU称为**datagram分组/数据报**，传输层PDU称为**segment报文/用户数据报**，应用层PDU称为**message消息**。

网络协议：为进行数据交换建立的规则集合。协议只规定于对等实体之间，即同一层的实体间。

接口：相邻两层交换信息的连接点。比如相邻实体通过SAP服务访问点交互，SAP就是一种逻辑接口。

计算机网络提供的服务可按三种方式分类：
* **面向连接服务和无连接服务**
  * 面向连接的服务：双方通信前必须先建立连接和分配资源，通信结束后必须释放连接和资源。通常有连接建立 - 数据传输 - 连接释放三个阶段。
  * 无连接服务：通信双方不需要先建立连接，这是一种**不可靠**服务，提供Best effort delivery最大努力交付。
* **可靠服务和不可靠服务**：
  * 可靠服务：网络具有纠错、检错、应答机制，能保证数据正确、可靠地到达目的地。
  * 不可靠服务：网络尽量正确、可靠地传送，不做任何保证。
* 有应答服务和无应答服务

#### OSI参考模型

开放系统互连参考模型（OSI/RM），简称OSI参考模型。共7层，低三层为通信子网，高三层为资源子网。

* Physical Layer物理层：在物理媒体上透明地传输原始比特流，主要规定数据终端和数据通信设备的物理与逻辑连接方法，因此物理层协议也叫**物理层接口标准**。物理层的内容：
  * 规定电路接口的参数，比如电脑网线接口的参数。
  * 规定通信链路上传输的信号的意义和电器特征，比如规定0和1代表的信号是什么。
  * 但是传输用到的物理媒体，比如双绞线、光缆、无线信道等，不属于物理层而在物理层之下，可以称为第0层物理媒体层。
* Data Link Layer数据链路层：组装帧、差错控制、流量控制、传输管理。
* Network Layer网络层：控制通信子网的运行，包括分组路由选择、差错控制、流量控制、拥塞控制、网际互连。提供点到点通信。
* Transport Layer传输层：为端到端连接提供**可靠（即是面向连接的）**的传输服务，包括差错控制、流量控制、服务质量、数据传输管理。提供端到端通信。
* Session Layer会话层：为表示层实体或用户进程建立连接并在连接上有序地传输数据，即进行会话。会话层可以建立、管理及终止会话，还可以使用校验点在通信失效时恢复通信。
* Presentation Layer表示层：处理交换的信息的表示方式。定义数据结构，选用编码方式，还可以提供数据压缩、解密加密等功能。
* Application Layer应用层：与用户交互。

#### TCP/IP模型

TCP/IP模型是广泛应用的标准，是事实上的国际标准。

* 网络接口层：对应OSI的物理层和数据链路层。
* 网际层：与OSI网络层类似。
* 传输层：与OSI传输层类似。
* 应用层：所有高层协议。

王道p19图：TCP/IP模型以IP作为核心协议，提供everything over IP的服务，以及IP over everything的在IP协议各种网络上运行。

TCP/IP与OSI参考模型的比较：王道p19，OSI参考模型的网络层支持面向连接和无连接的通信，但传输层只有面向连接的通信；TCP/IP模型的网络层只有无连接的通信，但传输层支持面向连接和无连接通信。

学习时采用折中的观点，学习五层结构。

## 物理层

### 通信基础

#### 基本概念

数据：
* 模拟信号：连续变化的信号
* 数字信号：取值为离散数值的信号

码元：用一个固定时长的信号波形表示一位k进制数字，是数字信号的计量单位。

信道：在信源和信宿之间传递数据的逻辑部件，一般指传送数据的介质。

信道上传输的信号有基带信号和宽带信号之分（王道p60）：
* **基带传输**：基带信号将**数字信号**1和0直接用两种电压表示，然后传送到**数字信道**上传输
* **频带传输**：将数字信号调制成**模拟信号**，然后传送到**模拟信道**上传输。
* **宽带传输**：将频带传输中的链路分为多个信道，每个信道传输不同的信号，比如采用频分复用技术。

三种基本的通信方式（[wiki](https://zh.wikipedia.org/wiki/%E9%9B%99%E5%B7%A5)）：
* 单工通信：只有一个方向的通信，只有一条信道。”电视信号“。
* 半双工通信：通信双方都可以发送和接收，但是不能同时进行，需要两条信道。“对讲机”。
* 全双工通信：通信双方都可以发送和接收，也需要两条信道。“双向车道”。

码元传输速率：单位时间传输码元的个数，也可以称为脉冲个数或信号变化的次数，单位是Baud波特。

#### 奈奎斯特定理与香农定理

Nyquist定理：理想低通信道中，**极限码元传输速率**为**2W波特**，其中W是理想低通信道的带宽。

用V表示每个码元离散电平的数目（即有多少种不同的码元，n个二进制位就可以表示2^n个不同的码元），则可得**极限数据传输率**为`2W * log2(V)`，单位是b/s。

Shannon定理：给出了带宽受限且有高斯白噪声干扰的信道的**极限数据传输率**，为`W * log2(1 + S/N)`，单位是b/s，其中W是信道的带宽，S是信道所传输信号的平均功率，N是信道内部的高斯噪声功率。

S/N即为信噪比，即信号的平均功率与高斯噪声的平均功率之比，`信噪比 = 10 * log10(S/N)`，单位为dB。

#### 调制与编码

传输数据时需要将数据转换为信号，将数据变为模拟信号的过程称为调制，将数据变为数字信号的过程称为编码。

四种转换方式：
* 数字数据**编码**为数字信号：编码主要就是规定什么数字信号表示0和什么数字信号表示1，常用的编码方法有：
  * 非归零编码(NRZ)：用一个电压表示一个二进制数字。简单，但无法判断一个码元的开始和结束
  * 非归零反向编码(NRZI)：与前一码元的电平相反表示1，相同表示0（或01的表示反过来）
  * **曼彻斯特编码**：将一个码元分成两个相等的间隔，前一个为高电平后一个为低电平表示码元，相反的表示0（或相反表示，都可以）。每个码元中间出现的跳变，既包含时钟信号，又包含数据信号，码元宽度和NRZ相同，但是所占的频带宽度是原始基带宽度的2倍，**以太网使用的就是曼彻斯特编码**。
  * 差分曼彻斯特编码：前半个码元的电平与上一个码元的后半个电平相同表示1，相反表示0，同样在每个码元的中间都有一次电平跳转。
  * 4B/5B编码
* 数字数据**调制**为模拟信号：调制技术在发送端将数字信号转换为模拟信号（调制），在接收端将模拟信号还原为数字信号（解调）
* 模拟数据**编码**为数字信号：主要包括采样、量化和编码。
  * 奈奎斯特采样定理：采样频率至少为原始信号最大频率的两倍，才能保证采样后的数字信号完整保留原始模拟信号的信息。
* 模拟数据**调制**为模拟信号。

#### 电路交换、报文交换与分组交换

电路交换：进行传输前，两个节点间必须先建立一条专用的物理通信路径，在传输过程中一直被独占。因此电路交换有连接建立 - 数据传输 - 链接释放三个阶段。电路交换的特点：
* 数据传输时延小，不会有存储转发耗费时间
* 有序传输：顺序传送数据，不会出现失序问题
* 没有冲突
* 交换机等控制简单
* **无法纠错**
* 建立连接时间长

报文交换：存储转发方式。特点：
* 报文大小没有限制，需要网络结点有较大的缓存空间（报文需要全部暂存在中间结点）
* 现在很少使用，被分组通信方式所替代

分组交换：也是存储转发方式，限制了分组大小上限。分组交换有两种方式（王道p39表2.1对比）：
* 数据报：将数据报拆成数据报分组发送，不同的分组可以走不同的路线，可也以不同顺序到达
  * 无连接，不可靠
  * 网络有冗余路径，对故障适应能力强
* 虚电路：在分组发送前，建立逻辑相连的虚电路，且建立后就固定虚电路的物理路径
  * 面向连接，提供可靠的传输，保证每个分组有序到达
  * 虚体现在，每个结点可以同时被多条虚电路经过
  * 虚电路的持续时间可以不同，有临时性的，也有永久的虚电路

### 传输介质

双绞线：
* 最常用的古老传输介质，常用于局域网和传统电话网络
* 带宽取决于铜线的粗细和传输的距离
* 模拟传输和数字传输都可以使用

同轴电缆：
* 50Ω同轴电缆用于传输基带数字信号 - 基带同轴电缆，在局域网应用广泛
* 75Ω同轴电缆用于传输宽带信号 - 宽带同轴电缆，常用于有线电视
* 传输距离比双绞线长，但更贵

光纤：
* 由纤心和包层组成，纤心不是中空的
* 纤心折射率高，包层折射率低，因此光线在光纤中发生全反射，以此向前传播
* 多模光纤：多束光线同时在一条光纤传播，传输距离短
* 单模光纤：光线直径为一个光波长度，光线反射次数很小，传输距离长

物理层尽可能屏蔽物理设备的差异，不关注具体的传输媒介（王道p59图2.12），物理层的主要任务可以描述为确定与传输媒体的接口有关的一些特性：
* 机械特性：主要定义物理连接的边界点，即接插装置的规格、引线数目、引脚等。
* 电气特性：规定传输二进制位时，线路上信号的电压高低、阻抗匹配、传输速率和距离限制等。
* **功能特性**：指明某条线上出现的某一电平的电压表示什么意义（即比如编码规则），接口部件的信号线（数据线、控制线、定时线）用途。
* 规程特性：主要定义各条物理线路的工作规程和时序关系。

### 物理层设备

**中继器/转发器**：处理对象是**信号**，将信号整形并放大（原理是信号再生，并非简单放大）再转发出去，以消除信号经过一长段电缆后，因噪声或其他原因造成的失真和衰减。

中继器放大数字信号，放大器方法模拟信号。

**如果一个设备有存储转发功能，那么认为它可以连接两个不同的协议**，称为存储转发设备，没有存储转发功能的设备称为直通式设备。中继器没有存储转法功能，因此不能连接两个速率不同的网段，不能连接不同的协议（**指物理层协议不同的网段不能互连，与上层协议是否相同无关**，王道p57选择题3），中继器扩大了网络规模，但是相连部分仍是一整个局域网。

**Hub集线器**：实质上是一个多端口的中继器。因此也只起到信号放大和转发的作用，不能隔绝冲突域；只能在半双工下工作，因此多个设备共用会降低效率；拓扑结构为星形。

#### 设备连接不同网络整理

若某一层的设备可以连接不同类型的网络，那么它连接的网络可以在**设备所处层及以下的层**使用不同的协议（设备向上层隐藏下层的具体实现，而上层的不同协议也不能被下层的设备处理，王道p137选择题4），比如：
* 交换机可以连接不同的网络，因此它可以连接物理层、数据链路层的不同协议，但数据链路层之上的协议必须相同。
* 路由器可以连接多个局域网，因此它可以连接物理层、数据链路层、网络层的不同协议，但是网络层之上的协议必须相同。
* 而中继器不能连接不同的网络。

## 数据链路层

### 数据链路层的功能

* 为网络层提供服务：可以提供无确认无连接，有确认无连接，有确认有连接的服务，不存在无确认有连接的服务。
* 组帧：将网络层的分组封装成帧，其中包括定义数据结构，首尾部分的帧定界等。
* 链路管理：主要用于面向连接的服务，提供通信前的状态确认、控制等。
* 流量控制：限制发送方的发送速率不超过接收方的接收能力，数据链路层是点对点的流量控制。
* 差错控制：
  * 位错：帧中某位出现差错。通常用CRC码检验，通过ARQ自动重传（丢弃错误帧，让发送方超时自动重传）请求重发出错的帧。
  * 帧错：帧丢失、重复或失序。用计时器解决丢失；用编号机制解决重复；失序的解决这里不关注。

### 组帧

组帧主要解决的问题有：
* 帧定界：确定帧的界限。
* 帧同步：从接收到的比特流中区分出起始和终止。
* 透明传输：不论数据中有什么比特组合都能传输，不会因出现与帧定界符相同的比特组合而传输错误。

组帧时既要加首部，也要加尾部。

组帧方法：
* 字符计数法：在帧头用一个计数字段标明帧内字符数（总字符数包括计数字段）。
* 字符填充的首位定界符法：字符填充法用一些特殊字符来标明首和尾，若帧的数据部分中也出现转义字符，发送方在之前再加一个转义字符，接收方收到后再去掉这个转义字符，达到透明传输。
* 比特填充的首位标志法：用`01111110`标志帧的开始和结束，同样为了实现透明传输，发送方在数据中遇到5个连续的`1`时，在之后插入一个`0`，接收方做相反操作。
* 违规编码法：用冗余的违规编码序列作为起始界定符，比如曼彻斯特编码的“高-高”和“低-低”，这时不需要任何填充就能实现透明传输。

### 差错控制

CRC码，见计组。

### 流量控制与可靠传输机制

**数据链路层的流量控制与可靠传输机制是交织在一起的**，三种常用的ARQ机制都是滑动窗口和超时重传结合的。

**流量控制**的两种主要方法：
* 停止-等待：发送方每发送一帧，都要等待接收方的确认后才能发送下一帧。
* 滑动窗口：发送方和接收方各维护一个窗口。**数据链路层的滑动窗口与传输层的滑动窗口相比，窗口大小是固定的**。

**可靠传输**的实现：
* 确认机制。
* 超时重传。其中，自动重传请求(Auto Repeat reQuest, ARQ)是常用方法，传统的自动重传有三种：
  * 停止等待(Stop and Wait)ARQ
  * 后退N帧(Go Back N)ARQ
  * 选择重传(Selective Repeat)ARQ

超时重传的三种常用方法中，后两种当窗口足够大时，帧在线路上可以连续流动，因此又称连续ARQ。

* **停止等待**：
  * **发送窗口大小 = 1，接收窗口大小 = 1**
  * 帧发送后，若发送方在计时器超时仍未收到确认，重新发送该帧
  * 接收方遇到帧错误，直接丢弃该帧
  * 发送的帧交替用0和1标识
* **后退N帧**：
  * **发送窗口大小 > 1，接收窗口大小 = 1**
  * 接收方对收到的最后一个连续无误的帧进行确认
  * 接收方不用在每收到一个帧就发送确认，可以在连续收到几个后发送最后一个确认
  * 发送方每个帧一个计时器，当一帧的计时器超时，重发该帧及该帧后**已发送的所有帧**
  * **若用nbit对帧编号，发送窗口尺寸最大为2^n - 1，超过会无法区分新帧旧帧**
* **选择重传**：
  * **发送窗口大小 > 1，接收窗口大小 > 1**
  * 接收方可以发送NAK给发送方，请求立即重传该帧
  * 接收方缓冲区用于暂存未按顺序收到的帧，大小等于窗口大小
  * 发送方每个帧一个计时器，超时重传对应帧
  * **若用nbit对帧编号，发送窗口和接收窗口大小和最大为2^n，超过会无法区分新帧旧帧**
  * 一般SR机制中发送窗口和接收窗口大小一样，因此它们最大尺寸都是2^(n-1)

与流量控制和可靠传输相关的计算：
* 信道效率/信道利用率：在一个发送周期内，发送方有效发送数据的时间
* 信道吞吐率：信道利用率 * 发送方的发送速率

### 介质访问控制

在广播中结点会共享广播信道，因此需要为使用介质（信道）的每个结点隔离来自同一信道上其它结点所传送的信号，即介质访问控制。

决定广播信道中信道分配的协议属于数据链路层的一个子层，称为**介质访问控制（Medium Access Control, MAC）子层**。

常见的介质访问控制方法：
* 信道划分介质访问控制：静态分配信道
* 随机访问介质访问控制：动态分配信道
* 轮询访问介质访问控制：动态分配信道

#### 信道划分介质访问控制

信道划分介质访问控制将使用介质的每个设备和其他设备隔离，将一条广播信道划分为逻辑上互不干扰的子信道，采用多路复用计数（一条介质同时携带多个传输信号）实现，种类如下：
* 频分多路复用FDM：共享时间，“公路划分为两个车道”
* 时分多路复用TDM：共享空间，“交替使用公路”。TDM的改进为统计时分多路复用，按需动态分配时隙。
* 波分多路复用WDM：即光的频分多路复用，在光纤中使用，共享时间
* 码分多路复用：共享时间空间，“黄豆绿豆装在一个车厢内运输”
  * **码分多址**(**Code Division Multiple Access, CDMA**)是码分复用的一种方式，将时间划分为时间槽，码片，每个站点有唯一的码片序列且相互正交，多个站点共享信道时，将他们对应的码片序列线性相加，最后与对应站点的码片序列做内积就能分解出信息。

#### 随机访问介质访问控制

不采用集中控制发送次序，既不共享时间也不共享空间，核心思想是争用信道的使用权，因此随机访问介质访问控制协议又称**争用型协议**。

* ALOHA协议：发送前不侦听
  * 纯ALOHA协议：
    * 站点不进行检测自由发送数据，若超时未收到确认，认为发生了冲突，等待一个随机时间后重传
    * 遇到碰撞时，碰撞双方都需要重传，等待时间是一个随机时间 
  * 时隙ALOHA协议：
    * 将时间划分为等长的时隙Slot，只能在每个时隙开始时发送帧，站点在发送前仍不进行检测
    * 遇到碰撞时，重传也是双方等待随机时间重传
* **CSMA协议**（**Carrier Sense Multiple Access，载波侦听多路访问**）：发送前会侦听信道是否空闲
  * 1-坚持CSMA（1-persistent CSMA）：
    * 发送数据前先侦听信道，若信道空闲，**立即**发送数据；若信道忙，则一直等待并监听
    * 遇到碰撞时，随即等待一段时间后再开始侦听
  * 非坚持CSMA（Non-persistent CSMA）：
    * 发送数据前先侦听信道，若空闲，**立即**发送数据；若信道忙，等待一个随机时间后再侦听
  * p-坚持CSMA（P-persistent CSMA）：
    * 发送数据前先侦听信道，若空闲，**不立即**发送数据，以概率p发送数据，概率1-p推迟到下一时隙再侦听，下一时隙若也空闲，以概率p发送，概率1-p推迟...；若在一开始检测到信道忙，等待到下一时隙再侦听；若在推迟过程中检测到信道忙，等待一个随机时间后再侦听
    * **首次遇到碰撞和1-p推迟后遇到碰撞的等待时间不同**
    * 不直接发送，持续侦听（指首次碰撞），p-坚持CSMA是前两种协议的折中
* **CSMA/CD协议**（**Carrier Sense Multiple Access with Collision Detection, CSMA/CD，载波侦听多路访问/碰撞检测**）：
  * 发送前侦听信道，若空闲则发送数据；若信道忙，则持续侦听到信道空闲
  * 传输过程中持续侦听信道，若没有侦听到别的信道发送，则成功传输；若侦听到有别的信道在发送，则终止传输，并发送一个拥塞信号，然后用**二进制指数退避算法**等待一个随机时间后再侦听
  * **争用期**：知道没有发生碰撞的最短时间，理解。求最短帧长。
  * 二进制指数退避算法：
    * 基本退避时间：一般为争用期时间
    * 参数k = min{重传次数，10}
    * 从[0, 1, 3, 7...2^k-1]中随机选出一个作为r，退避时间 = r * 基本退避时间
    * 重传16次仍不成功，放弃重传该帧 
* **CSMA/CA协议**（**Carrier Sense Multiple Access with Collision Avoidance, CSMA/CA，载波侦听多路访问/碰撞避免**）
  * CSMA/CD用于有线局域网，但在无线局域网下需要进行改进，因此将碰撞检测改为碰撞避免，避免指尽量降低发生碰撞的概率，但不能完全消除碰撞
  * 基本思想是在发送数据前告诉其他结点不要发送数据，以避免发送碰撞，实现冲突避免的机制有：
    * 预约信道：发送数据的同时通知其他结点自己占用的时间长度
    * ACK帧：接收成功后发送ACK帧，发送方超时未收到ACK帧认为发送失败
    * RTS(Request to Send)/CTS(Clear to Send)帧：可选机制，解决“隐蔽站”问题。（王道p97选择27，RTS和CTS用于预约信道）
  * 在发送前使用二进制指数退避算法等待退避时间，避免冲突

#### 轮询访问介质访问控制

轮询方式用户不能随机发送数据，需要通过集中控制的控制站，轮询每个结点决定信道分配，且某结点使用时，其他结点不能使用信道。

令牌传递协议（王道p107还有介绍）：
* 令牌是有一组特殊的比特组成的控制帧
* 只有拥有令牌才能传输数据，拥有令牌的结点发送帧，帧在环上传送时所有结点都会转发，传送完一帧后，释放令牌
* 只有一个令牌，因此不会出现冲突
* 逻辑拓扑为环形，物理拓扑为星形
* 令牌传递协议适用于负载高的广播信道，因为相比于随机访问介质访问控制，不会出现冲突

### 局域网

#### 局域网的基本概念与体系结构

局域网（Local Area Network，LAN）是一个较小范围内的网络。目前使用范围最广的局域网是Ethernet以太网。

IEEE 802标准定义的局域网对应于OSI参考模型的数据链路层和物理层，并将数据链路层拆为两个子层：LLC逻辑链路控制子层和MAC介质访问控制子层，LCC子层在上（王道p103）。

#### 以太网

**以太网**：符合DIX Ethernet V2标准的局域网，但该标准与IEEE 802.3相差无几，因此称802.3局域网为以太网。

性质：
* IEEE 802.3标准是一种基带总线形的局域网标准，描述物理层和数据链路层的MAC子层的实现方法。
* 逻辑拓扑为总线形，物理拓扑为星形或拓展星形。
* 信息以**广播**方式发送，网卡收到帧时，先检查目的地址，如果是发给自己的就接收，否则丢弃。
* 数据链路层使用**CSMA/CD**方式进行介质访问控制。
* **以太网简化通信的措施**：无连接；不对帧编号；不使用确认帧；提供不可靠服务。
* **以太网传输介质**：王道p104表3.2，10BASE-T中每个符号的含义。还有p105的高速以太网。
* **网卡**：
  * 又称网络适配器（Network Adapter）或网络接口卡（Network Interface Card，NIC）
  * 是数据链路层设备，连接计算机与传输介质，主要工作与物理层交互
  * 网卡在出厂时有唯一的代码，**介质访问控制地址（MAC地址）**（因此我以为网卡的MAC地址和介质访问控制是两个东西，以为错了一年），又称物理地址，长6个字节，每个字节的十六进制数用-或:隔开，高24位为厂商代码，低24位为厂商自行分配的网卡序列号。

**以太网帧的格式**：王道p105图，不包括前导码的首部尾部和数据最短**64B**，与CSMA/CD算法计算的最短帧长64B对应。
* 前导码：8B。以太网帧不需要帧结束符，因为物理层传送时帧之间有一定间隙，但没有帧结束符不等于没有数据链路层添加的尾部。
* 目的地址，源地址：共12B，**目的地址在前**。
* 类型：2B，指出携带的数据应交给哪个协议处理。
* 数据：**46B~1500B（带上首尾64B~1518B）**，数据链路层帧能承载的最大数据量称为MTU最大传送单元，以太网帧的MTU为1500B；数据长度不足46B时，必须填充到46B。
* 校验码：4B CRC码，校验除前导码外的所有字段。

#### IEEE 802.11

IEEE 802.11是无线局域网的协议标准，制定了介质访问控制层的协议，能运行在多个物理层标准上。采用**CSMA/CA协议**进行介质访问控制。

无线局域网有两大类，不重要，见王道。

### 广域网

广域网（Wide Area Network，WAN）指覆盖范围很广的长距离网络。**局域网覆盖物理层和数据链路层，而广域网覆盖物理层，数据链路层和网络层三层**。

**局域网使用广播技术，广域网使用交换技术(分组交换)**。

目前最常用的两种广域网数据链路层控制协议：
* PPP协议
* HDLC协议

#### PPP协议

点对点协议（Point to Point Protocol，PPP）：使用串行线路通信的**面向字节**的数据链路层协议，用于建立点对点连接发送数据，应用在直接连接两个结点的链路上。
* PPP帧格式：
  * 数据部分长为**0~1500B**，没有最短限制，因为PPP是点对点的，没有冲突，也不使用CSMA/CD协议
  * 采用CRC校验
* 使用特殊的字符填充法实现透明传输
* 不可靠的传输协议，没有序号和确认机制
* 只支持点对点通信
* 只支持全双工链路
* 两端可以运行不同的网络层协议

#### HDLC协议

高级数据链路控制协议（High Level Data Link Control, HDLC）：ISO制定的**面向比特**的数据链路层协议。
* HDLC帧格式：
  * 与PPP帧相比，只少一个2B的协议字段
  * 采用CRC校验
* 使用比特填充实现透明传输
* 可靠传输，对帧顺序编号，有确认机制
* 有主站-从站的非平衡传输，也有复合站间的平衡传输
* 全双工通信

### 数据链路层设备

**网桥**：工作在数据链路层的MAC子层，处理对象是**帧**。网桥会决定帧的传输方向。可以连接不同类型的局域网，隔绝冲突域，不会降低传输速率，可以使用不同的物理层。

广播风暴：局域网采用广播方式传输数据，而当 广播信息过多/有环路 就会导致广播风暴，使线路瘫痪。

根据路径选择算法的不同，可以将网桥分为两种：
* 透明网桥：
  * 网桥维护转发表来决定是否丢弃帧或帧发向哪里
  * 采用生成树算法避免环路
  * 未选择最佳路由（往返时间最短的路由，不是跳数最少的路由）
* 源路由网桥：
  * 对主机不透明，路由选择由主机负责
  * 通过广播发现帧选择最佳路由

**交换机**：局域网交换机，或以太网交换机，本质上是一个多端口的网桥。维护动态查找表进行路由选择。

交换机可以实现VLAN虚拟局域网，VLAN不仅可以隔绝冲突域，还可以隔绝广播域，解决广播风暴。

交换机不会降低用户传输速率，每个端口的带宽都是传输介质的带宽，即10Mbps的交换机每个用户都是10 Mbps，因此N个用户全双工下总传输速率10N Mbps，半双工下5N Mbps。

交换机有两种交换模式：
* 直通交换：只检查帧的目的地址。速度快，但不支持不同速率端口的交换。
* 存储转发：将收到的帧缓存到高速缓存中，并检查数据是否正确，然后查表转发出去。延迟大，可靠性高，并支持不同速率端口的交换。

**局域网、广域网、以太网、因特网的区别**：局域网是小范围的网络；广域网是多个交换机相连多个局域网，组成一个大的网络；多个大的网络由路由器相连组成因特网；而以太网只是一个使用最广的局域网。

## 网络层

### 网络层的功能

* 异构网络互联
* 路由与转发：路由选择和分组转发
* **拥塞控制**：从**全局**角度确保子网能够承担所到达流量，涉及网络中的所有主机、路由器等。拥塞控制与流量控制不同，流量控制只关注两点间的传输过程，控制发送方的发送速率，而拥塞控制是关乎通信子网全局的。拥塞控制有两种方法：
  * 开环控制：静态
  * 闭环控制：动态

### 路由算法

* 静态路由算法：网络拓扑或状态变化时，由管理员手工修改路由表
* 动态路由算法：RIP, OSPF 

路由算法见4.5节。

### IPv4

#### IPv4分组

**Ipv4分组格式**：固定首部长20B，[参考](http://www.tcpipguide.com/free/t_IPDatagramGeneralFormat.htm)
* 首部长度：4bit，分组首部的长度，**单位是4B**
* 总长度：2B，**单位是1B**，当封装成帧时，最大长度为1500B
* Identification标识
* Flags标志：3bit，第一位保留（没用），后两位是MF和DF，MF（More Fragment）= 1表示后续还有分片，DF（Don’t Fragment）= 0对数据报进行分片
* 片偏移：13bit，分片后的偏移量，只算数据长度，不包含首部，**单位是8B**
* 首部校验和：只校验分组首部，不校验数据

IP数据报分片：当分组长度大于数据链路层的MTU时，需要进行分片，分片有可能发生在发送端和发送过程中路由器上，**不同网络的MTU不同，因此可能在发送中多次分片，但只会在目的主机重组**。

在发送前将分组分片，接收方进行重组，组装时根据IP首部中的标识、标志和片偏移三个字段进行重组。当创建一个IP数据报时（分组前），数据报会被加上一个标识号，当对该数据报进行分片时，每个片都有这个相同的标识号，因此有相同标识号的片在重组时会被组在一起；查看标志位中的MF和DF，DF = 0表示进行分片，MF = 1表示这个片不是最后一片，MF = 0表示最后一片；重组时还根据片偏移进行计算，**片偏移字段单位为8B，因此分片数据长度除最后一片外必须是8的倍数**。

路由器进行分组转发有两种方式：
* 直接交付：目的地址和发送方在同一网段下，不经过路由器直接发往目的主机
* 间接交付：目的地址和发送方不在同一网段下，寻找下一条路由器再继续转发

#### IPv4地址

**两级IP地址**格式：`<网络号>, <主机号>`。

王道p147，两级IP地址不同类别网络的地址范围、可用数目。

不能用的地址：主机号全0表示本网络；主机号全1表示广播地址；127.x.x.x用作环回地址，常用的127.0.0.1表示本主机（[延申](https://www.howtogeek.com/149227/whats-the-difference-between-127.0.0.0-and-127.0.0.1/)）；0.0.0.0表示本主机所有IP的集合；

路由器仅根据网络号转发分组，不考虑主机号。

NAT网络地址转换：将<私有地址 : 端口>与<公有地址 : 端口>进行转换，以缓解IP地址不足的问题。传统的两级IP地址中有一些划分好的私有地址段，私有地址只能在局域网上使用，不能在广域网上使用。

普通路由器在转发数据报时，不会修改IP源地址和目的地址，但是**NAT路由器在转发时一定要转换IP地址**，且不同于普通路由器工作在网络层，NAT路由器转换时会查看传输层端口号。

**子网划分**：由于两级IP地址不够灵活，增加子网号字段，对子网再划分，形成**三级IP地址**`<网络号>, <子网号>, <主机号>`。子网划分是在两级IP地址的基础上对原主机号进行划分，网络号不变，对外表现仍为没有划分子网的网络。

此时子网号一般不能为全1或全0，主机号一定不能为全1或全0，主机号全1表示子网广播地址，全0表示子网的网络号。

子网掩码：为了表示对哪几位进行了子网划分，引入了子网掩码，地址一样长32bit。子网掩码1对应的位数为网络号及子网号，0对应位数为主机号。

**无分类域间路由选择CIDR**：消除网络划分，IP地址格式变为无分类的两级地址`<网络前缀>, <主机号>`，用子网掩码标识网络前缀。

网络前缀相同的连续IP地址组成CIDR地址块，一个CIDR地址块可以表示多类传统地址，这种地址的聚合称为路由聚合，可以减少路由表中的条目数。

主机号全0和全1仍然不能使用，全0表示网络号，全1表示广播地址。选择路由时采用最长前缀匹配。

#### ARP协议

数据传送时，每次经过路由器由于到达不同的链路，都会对数据链路层帧进行重新封装，因此MAC地址会不断变化，但IP地址不变，因此网络层通过IP地址通信，而链路上根据MAC地址进行传送，因此每次路由器转发时需要进行IP地址到MAC地址的转换。

**地址解析协议（Address Resoluiton Protocol, ARP）**：完成IP地址到MAC地址的映射，每台主机都有一个ARP表记录这些映射，是**网络层协议**。

工作方式：
* 查找ARP表，寻找目的主机的IP地址，若有，则将对应MAC地址作为目的地址写入帧，发送数据报
* 若没有，以FF-FF-FF-FF-FF-FF作为目的地址**广播**ARP请求
* 目标主机收到广播请求后，**单播**ARP响应给主机，主机得到目的MAC地址，发送数据

#### DHCP协议

**动态主机配置协议(Dynamic Host Configuration Protocol, DHCP)**用于给主机动态分配IP地址，**基于UDP**，是**应用层协议**。

工作方式：
* 客户机**广播**请求，DHCP服务器收到后为其动态分配一个IP地址，**广播**响应
* 因为客户端还没有获得IP地址，所以客户端与服务器的**所有通信都是用广播进行的**，并且无法建立连接，传输层都是采用**UDP**的

#### ICMP协议

**网际控制报文协议(Internet Control Message Protocol, IMP)**用于报告差错和异常，是**网络层协议**。

ICMP报文有两种：
* ICMP差错报文：路径上的结点向源主机报告差错和异常
  * 终点不可达
  * 源点抑制：中间结点由于拥塞丢弃数据报时，向源点发送此报文以让其降低发送速率
  * 超时：路由器收到TTL = 0的报文时，向源点发送；或预定时间内未收到全部报文时向源点发送
  * 参数问题：数据报首部字段出错
  * 改变路由：路由器以此通知源主机下次可以发送给更好的路由
  * 不使用ICMP差错报文的情况：ICMP报文自身出错，一个数据报的所有后续分片，具有组播地址的数据报，特殊地址（如127.0.0.0和0.0.0.0）的数据报
* ICMP询问报文：
  * 回送请求和回答
  * 时间戳请求和回答
  * 掩码地址请求和回答
  * 路由器询问和通告

ICMP报文的常见应用：
* PING命令：使用了ICMP回送请求和回答报文。工作在应用层，但直接使用ICMP协议，不使用TCP/UDP。
* Traceroute命令：使用了ICMP超时报文。工作在网络层。

### IPv6

特点：
* 地址空间128bit
* 没有校验和字段
* 首部长度固定（IPv4首部长度有可选字段）
* IPv6的数据报只有在源结点才能分片，传输过程中的路由器不能分片，这一点与IPv4不同
* 首部长度是8B的整数倍，IPv4的首部长度是4B的整数倍
* 安全性，比如身份验证和保密功能
* 虽与IPv4不兼容，但总体上与其他网络协议兼容
* 目的地址有三种：
  * 单播
  * 多播
  * 任播
* 地址格式：
  * 每16位用十六进制表示，用冒号隔开，共8组，`4BF5:0000:0000:0000:BA5F:039A:000A:2176`
  * 可以略去每组开头的若干个0，但最少要保留一个数字，`4BF5:0:0:0:BA5F:39A:A:2176`
  * 可以缩写相继的0，但为了推断长度，只能缩写一次，`4BF5::BA5F:39A:A:2176`
* 扩展了IPv4地址分级的概念，有三级地址
* IPv4向IPv6过渡的办法：
  * 双协议栈：主机或路由器装有两个协议的协议栈，进行转换
  * 隧道技术：将IPv6数据报封装入IPv4的数据部分，在IPv4的隧道传输

### 路由协议

自治系统（Autonomous System，AS）：自治系统内部所有路由器都是连通的，使用同一种路由选择协议

自治系统内部的路由选择叫域内路由选择，使用内部网关协议（Interior Gateway Protocol，IGP），常见RIP和OSPF；自治系统间的路由选择叫域间路由选择，使用外部网关协议（External Gateway Protocol，EGP），常见BGP。

#### RIP协议

路由信息协议（Routing Information Protocol，RIP），采用距离-向量（distance-vector）算法，特点如下：
* 路由表条目：目的网络，下一跳路由器，跳数
* 定期与**相邻结点**交换**整个路由表**
* metrices/hop count跳数是抽象距离，即源端口到目的端口经过的路由个数，直连设备跳数为1，跳数最大为15，跳数16视为不可达
* 收到相邻结点发来的RIP报文时，对于报文中的路由条目：
  * 目的网络不存在路由表中，将路由加入路由表
  * 目的网络相同，下一跳地址相同，不论距离是否更短，都要更新路由表
  * 目的网络相同，下一跳地址不同，若距离短，更新路由表
* 选择的是经过路由器最少的路径，不一定是时间最短的 
* 收敛慢，因而会导致回路
* **应用层协议**，**基于UDP**，端口520

#### OSPF协议

开放最短路径优先协议（Open Shortest Path First，OSPF），采用链路状态（link-state）算法，特点如下：
* 结点的链路状态变化时，广播给**所有其他结点**该结点**相邻路由器的链路状态**，采用Flooding洪泛法广播
* 发送的信息比RIP的信息多，包括费用、距离、时延等
* 结点用Dijkstra算法计算最短路径，构建路由表（表中不存储完整路径，只存储下一条地址）
* 所有结点的信息一致
* 只交换相邻结点的链路信息，与全局状态无关，因此网络规模大时OSPF协议比RIP协议效果好
* 收敛快
* **网络层协议**，基于**IP**，IP数据报头协议字段为89

#### BGP协议

边界网关协议（Border Gateway Protocol，BGP）用于网关之间选择路由，采用路径-向量算法，特点如下：
* 每个自治系统选择至少一个边界路由器，边界路由器之间交换信息
* BGP路由表包含目的网络地址，下一跳路由器，需要经过的自治系统序列
* BGP刚运行时，与**相邻结点**交换**整个路由表**，以后只交换**变化的部分**，且交换的是**可达性信息**（从一个自治系统到另一个自治系统经过的自治系统）
* 路径选择时只选择较好的路由，而非最佳路由
* **应用层协议**，基于**TCP**

王道p181表4.3，三种协议对比。

### 组播/多播

组播可以发送一次数据，让若干目标主机都收到。

* 组播的数据报在路径分叉时才会被复制，能运行组播协议的路由器叫组播路由器。
* **基于UDP**
* 组播地址为D类地址，每个D类地址表示一个组播组，只能作为目的地址而不能作源地址
* 组播数据报的协议字段为2，表明使用IGMP
* 组播数据报不产生ICMP报文，因此PING组播地址不会收到响应

组播分为硬件组播和在因特网上的组播，而后者最后也要进行硬件组播。IANA（互联网号码分配局）为组播MAC地址分配了范围，只有23位可用于组播，因此需要进行D类IP地址到MAC地址的映射。

因特网组管理协议（Internet Group Management Protocol，IGMP）用于管理组播成员。使用组播路由选择协议生成组播路径最短的组播转发树。

### 移动IP

移动IP技术是指移动结点以**固定的IP地址**实现跨越不同网段的漫游功能，并保证基于IP的网络权限在漫游过程中不发生任何改变。

基本功能实体：
* 移动结点
* 本地代理/归属代理：在归属网络中转交数据报给移动结点
* 外部代理/外埠代理

移动结点在归属网络中，以传统TCP/IP方式通信；漫游到外地网络时，由本地代理转发数据报实现通信。

移动IP网络仍使用固定互联网的路由选择协议。

### 网络层设备

**路由器**的组成（王道p194结构图）：
* 路由选择部分（控制部分）：根据路由协议构造、维护路由表
  * 路由选择处理机
  * 路由选择协议
  * 路由表
* 分组转发部分：从物理层比特流中提取出帧，再提取出数据报，然后根据转发表转发，再依次封装成比特流
  * 输入端口
  * 输出端口
  * 交换结构

路由器实现涉及**物理层、数据链路层、网络层**的功能。

## 传输层

### 传输层提供的功能

提供端到端通信。

复用和分用：？？？

网络层的复用和分用：不同的协议都可以封装成IP数据报发送，接收方将首部去掉后可以把数据交付给相应的协议。

端口：
* 传输层的服务访问点（SAP）。网络层SAP是IP地址，数据链路层SAP是MAC地址。
* 端口号：长16bit，只有本地意义，不同计算机可以有相同的端口号，按端口号范围分为两类：
  * 服务端使用的端口号：
    * 熟知端口号：0~1023，给最重要的程序使用。常用的熟知端口号：（FTP - 21, TELNET - 23, SMTP - 25, DNS - 53, TFTP - 69, HTTP - 80, SNMP - 161）
    * 登记端口号：1024~49151
  * 客户端使用的端口号：49152~65535，仅在客户端运行时才会动态选择

Socket套接字：IP地址 + 端口号，用于标识主机上的唯一进程。

### UDP

**UDP报文格式**，首部长**8B**：
* 源端口：2B
* 目的端口：2B
* 长度：2B，单位是1B，长度最小为8，表示只有首部
* 校验和：2B，可选，若不使用令该字段全为0

若接收方发现收到的报文中端口号不正确，丢弃报文，并向发送方发送ICMP端口不可达差错报文。

UDP校验：
* 在发送方计算校验和：添加12B的伪首部，包括源IP地址和目的IP地址，若总长为奇数，在最后补上一个全0字节，计算所有字段的和，取反码写入校验和字段（校验和字段初始全0），计算完后去掉伪首部和补的字节
* 在接收方加上伪首部和可能的补字节，计算全部字段的和，若不是全为1则表明有差错
* **UDP校验是可选的**，若不使用校验则首部校验和字段全填0

UDP校验可以检查UDP首部和数据，还可以检查伪首部中的IP地址。

### TCP

#### TCP报文

**TCP报文格式**，固定长**20B**，总长为4B的整数倍：
* 源端口：2B
* 目的端口：2B
* 序号：4B，表示本报文发送的第一个字节的序号
* 确认号：4B，期望收到的下一个字节的序号，表明前面的字节都已正确收到
* 数据偏移：与IP的分片数据偏移不同，这里就是指首部长度，单位为**4B**
* 确认位ACK：ACK = 1时确认号才有效
* 同步位SYN
* 终止位FIN
* 窗口字段：指允许对方发送的数据量，即接收方的接收缓存大小，发送方以此确定发送窗口的大小，单位为**4B**
* 校验和：和UDP一样加上12B的伪首部校验，校验机制与UDP一样
* 选项字段：最大报文长度(Maximum Segment Size, MSS)，报文数据字段的最大长度

#### TCP连接管理

TCP提供**全双工通信**，通信双方可以在任何时刻发送数据。

**三次握手**：
* `SYN = 1, seq = x`，客户端发送建立连接的请求，不携带数据，序号x是随机选的
* `SYN = 1, ACK = 1, seq = y, ack = x+1`，服务端同意建立连接就发送确认，并为连接分配TCP缓存和变量，也不携带数据，序号y随机
* `ACK = 1, seq = x+1, ack = y+1`，客户端收到服务端确认后，向服务器发送确认，并为连接分配缓存和变量，这个报文可以携带数据，也可以不携带，若不携带数据则不消耗序号

**四次挥手**：
* `FIN = 1, seq = u`，客户端欲关闭连接，发送请求释放连接的报文（FIN = 1），不携带数据，序号u为已传送最后一个字节的序号加1
* `ACK = 1, seq = v, ack = u+1`，服务端收到请求，发送确认，序号v为服务端已传送最后一个字节的序号加1。此时**客户端到服务端的连接释放了，但是服务端还可以向客户端发送数据**
* `FIN = 1, ACK = 1, seq = w, ack = u+1`，服务端没有要向客户端发送的数据，发出请求释放连接的报文（FIN = 1）
* `ACK = 1, seq = u+1, ack = w+1`，客户端收到服务器释放连接的请求，发送确认，**此时TCP连接还未释放，等待计时器设置的2MSL时间后，客户端才释放连接资源，连接才关闭**

关于四次挥手的最后一次客户端等待的2MSL：[参考](https://www.zhihu.com/question/67013338)，2MSL的目的是**保证客户端最后一次发送的ACK被服务端成功接收到**。客户端发送最后一次ACK后，两种情况可能发生，第一种，服务端收到ACK，关闭连接；第二种，服务端没有收到ACK，直到它发送的FIN超时未收到确认，重传FIN给客户端，这时客户端会再收到FIN，再发送ACK确认，而这整个过程的时间不会超过2MSL（MSL的时间原比重传定时器大），就保证了客户端等待2MSL能确认ACK被服务端收到。


#### TCP可靠传输

* 序号
* 确认：确认序号为希望收到下一个字节的序号
* 重传：两种情况会进行重传：
  * 超时：TCP有一个计算方法不断计算RTT，且以此计算超时重传时间RTO，超时计时器达到RTO仍未收到确认，重传报文。
  * 冗余ACK：接收方每次收到一个比期望序号大的失序报文，就会发送一个**冗余ACK**（正常顺序收到报文时，已经发送了一个ACK给发送方，因此此时再发送的ACK就是冗余ACK）给发送方，当发送方收到对同一报文的3个冗余ACK时，就认为这个报文已经丢失，立即对其进行重传，也叫**快速重传**，使用在TCP拥塞控制中。

#### TCP流量控制

TCP采用滑动窗口实现流量控制，即发送方发送速率控制，发送方的发送窗口 = min{rwnd，cwnd}。

与数据链路层相比，TCP滑动窗口的窗口大小是可变的。TCP的滑动窗口可以看作是GBN和SR的混合体，[参考](https://www.zhihu.com/question/44602610)。

#### TCP拥塞控制

慢开始和拥塞避免：
* 慢开始阶段：刚建立连接时，cwnd = 1MSS，每收到一个新的ACK后，cwnd增大1MSS，因此每一个RTT之后，cwnd都会加倍（指数增长，**但是要避免思维定势，并不是所有发送情况都是如此，cwnd的增大依据是收到一个ACK增大1MSS**），直到cwnd等于慢开始门限/阈值ssthresh，且当指数增长时，若2cwnd > ssthresh，下一cwnd大小等于ssthresh，即拥塞窗口大小**不能跃过阈值**
* 拥塞避免阶段：每经过一个RTT将cwnd增大1MSS（线性增长）
* 网络拥塞处理：当出现超时，认为网络出现拥塞，让ssthresh = cwnd/2（但不能小于2），cwnd = 1（**这个变化过程经过一个RTT，不是瞬发的**），执行慢开始算法

快重传和快恢复：
* 快重传：用冗余ACK的发生表明网络出现拥塞，直接重传报文
* 快恢复：连接建立时，用慢开始算法，并在超过ssthresh时采用拥塞避免，冗余ACK发生后，让ssthresh = cwnd/2，cwnd = ssthresh （**这与慢开始和拥塞避免不同**），然后执行拥塞避免算法，因为跳过了慢开始阶段，因此称这种算法为快恢复

慢开始、拥塞避免、快重传、快恢复是一起使用的：连接建立时使用慢开始算法，超过阈值采用拥塞避免，发生超时使用慢开始和拥塞避免，收到冗余ACK时使用快重传和快恢复。

## 应用层

### 网络应用模型

* Client/Server，C/S
* P2P

### DNS

域名系统（Domain Name Syetem，DNS）：将域名转换为IP地址。采用C/S模型，**基于UDP**，端口53。

域名层次空间：域名（Domain Name）有多级，以`.`分开，从右到左级的别从高到低，.com/.cn是**顶级域名**，往左依次为二级域名、三级域名...

域名服务器（王道p246结构图）:
* 根域名服务器：有13个，**管理顶级域**，知道所有顶级域名服务器的IP地址，**当本地域名服务器无法解析域名，会首先求助于根域名服务器**。它通常不会应答转换的IP地址结果，而是会回复对应的顶级域名应请求的顶级域名服务器的IP地址
* 顶级域名服务器：管理所有在该顶级域名服务器注册的所有二级域名，收到请求时的应答可能是IP地址，也可能是下一个域名服务器的IP地址
* 授权域名服务器/权限域名服务器：每台主机都要在授权域名服务器登记
* 本地域名服务器：主机发送DNS请求时首先请求的服务器

域名解析过程，两种方式（王道p246图）：
* 递归查询：主机向本地域名服务器发送请求，然后本地域名服务器向根域名服务器发送请求...
* 递归查询和迭代查询相结合：主机向本地域名服务器发送DNS请求，若本地域名服务器没有对应IP地址，则以DNS客户的身份向根域名服务器发送请求...最后得到IP地址返回给主机

**结合王道p248选择题9理解请求过程，不同级别服务器的作用不同，请求时访问的顺序和次数也不同，比如这题根域名服务器和顶级域名服务器只请求一次，但两个权限域名就要请求两次权限域名服务器**。

### FTP

文件传输协议（File Transfer Protocol，FTP）：采用C/S模型，**基于TCP**，控制端口21，数据端口20。

FTP在进行一对传输时创建两个连接：控制连接和数据连接。控制连接传输控制信息，不传输数据，在传输过程中始终打开，因此也称FTP的控制信息是带外(out of bond)传输的；数据连接实际完成文件传送。

[FTP的主动模式和被动模式](https://blog.51cto.com/robingo/1935123)，客户端端口号肯定不是20/21，端口的0~49151都是给服务器用的，而FTP服务端的控制连接端口始终使用21，数据连接在主动模式下使用20，被动模式下由服务器和客户端协商。

### E-mail

### WWW万维网

